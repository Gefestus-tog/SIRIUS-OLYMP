<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта мест Сириуса</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cfa;
            --secondary-color: #3a5af9;

            --orange-color: #ffa15e;
            --lavande-color: #9c89fa;
            --green-color: #8dc157;
            --blue-color: #60a8f0;
        }
       
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            height: 100vh;
            background: #f8f9fa;
            overflow: hidden;
        }
        
        /* Сайдбар в стиле Яндекс */
        .sidebar {
            width: 380px;
            background: #fff;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            /* Убрал overflow: hidden */
        }
        
        .sidebar-header {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #eaeaea;
        }
        
        .sidebar-title {
            font-size: 24px;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }
        
        /* Категории в виде иконок */
        .categories-container {
            /* overflow-x: auto; */
            padding: 0 10px 10px;
            border-bottom: 1px solid #eee;
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px;
            min-width: 350px;
            min-height: 360px;
        }
        
        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 10px 0;
            border-radius: 12px;
        }
        
        .category-item:hover {
            background: #f0f5ff;
        }
        
        .category-item.active {
            background: #e6f0ff;
        }
        
        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(58, 90, 249, 0.2);
        }
        
        .category-icon i {
            font-size: 24px;
            color: white;
        }
        
        .category-name {
            font-size: 13px;
            color: #333;
            text-align: center;
            font-weight: 500;
        }
        
        /* Карта */
        #map {
            flex: 1;
            z-index: 1;
        }
        
        /* Кнопка добавления */
        .add-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #4a6cfa;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(74, 108, 250, 0.4);
            cursor: pointer;
            z-index: 1001;
            border: none;
            transition: all 0.3s;
        }
        
        .add-button:hover {
            background: #3a5af9;
            transform: scale(1.05);
        }
        
        /* Форма добавления маркера - ИСПРАВЛЕНА */
        .add-marker-form {
            background: #fff;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1002;
            width: 400px;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            padding-bottom: 10px;
        }
        
        .form-title {
            font-size: 22px;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 15px;
        }
        
        .form-group input, 
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, 
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #4a6cfa;
            outline: none;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload-btn {
            background: #f0f2f5;
            color: #555;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s;
        }
        
        .file-upload-btn:hover {
            background: #e4e6e9;
        }
        
        .file-upload-btn i {
            margin-right: 8px;
        }
        
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-name {
            font-size: 13px;
            color: #777;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .preview-container {
            margin-top: 15px;
            display: none;
        }
        
        .preview-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            display: block;
        }
        
        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            /* Убрал sticky и background */
            padding-top: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
            font-size: 15px;
        }
        
        .btn-primary {
            background: #4a6cfa;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3a5af9;
        }
        
        .btn-secondary {
            background: #f0f2f5;
            color: #555;
        }
        
        .btn-secondary:hover {
            background: #e4e6e9;
        }

        .cafe { background-color: var(--orange-color); }
        .restaurant { background-color: var(--orange-color); }
        .shopping { background-color: var(--blue-color); }
        .other { background-color: var(--blue-color); }
        .hotel { background-color: var(--lavande-color); }
        .museum { background-color: var(--green-color); }
        .monument { background-color: var(--green-color); }
        .theater { background-color: var(--green-color); }
        .cinema { background-color: var(--green-color); }
        .gallery { background-color: var(--green-color); }
        .park { background-color: var(--green-color); }
        
        /* Контейнер для мест - ИСПРАВЛЕН */
        .places-container {
            flex: 1;
            /* overflow-y: auto; */
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Добавил минимальную высоту для гарантии прокрутки */
            /* min-height: 200px; */
        }

        /* Карточка места */
        .place-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .place-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .place-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .place-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .place-rating {
            background: #ffd700;
            color: #333;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 16px;
            font-size: 14px;
        }

        .place-photo {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .place-address {
            font-size: 14px;
            color: #666;
        }
        
        .no-places {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }
        /* Стили для детального просмотра места */
.place-detail-container {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.detail-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.back-button {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #555;
}

.detail-title {
    font-size: 22px;
    font-weight: 700;
    color: #333;
    margin: 0;
}

.detail-photo {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 12px;
}

.detail-rating {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    color: #555;
}

.detail-rating .stars {
    color: #ffc107;
}

.detail-address {
    font-size: 16px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-address i {
    color: #777;
}

.detail-description {
    font-size: 15px;
    color: #444;
    line-height: 1.5;
}

.reviews-section h3 {
    margin: 20px 0 15px;
    font-size: 20px;
    color: #333;
}

.review-item {
    background: #f9f9f9;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.review-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
    color: #666;
}

.review-rating {
    color: #ffc107;
}

.review-text {
    font-size: 15px;
    color: #333;
    line-height: 1.4;
}

.add-review-form {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.rating-stars {
    display: flex;
    gap: 4px;
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
}

.rating-stars .fas, .rating-stars .far {
    transition: color 0.2s;
}

.rating-stars .fas {
    color: #ffc107;
}

.rating-stars .fa-star-half-alt {
    color: #ffc107;
}
        
        /* Адаптивность */
        @media (max-width: 900px) {
            .sidebar {
                width: 300px;
            }
            
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .add-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .add-marker-form {
                width: 90%;
                max-width: 400px;
            }
            
            .places-container {
                max-height: 200px;
            }
            .place-detail-container {
        padding: 10px;
    }
    
    .detail-photo {
        height: 150px;
    }
    
    .reviews-section h3 {
        font-size: 18px;
    }
    .back-button {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1;
    }
    
    .detail-header {
        padding-top: 40px;
        position: relative;
    }
        }
        .place-detail-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none; /* По умолчанию скрыт */
            flex-direction: column;
            gap: 15px;
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #555;
        }

        .detail-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .detail-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
        }

        .detail-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            color: #555;
        }

        .detail-rating .stars {
            color: #ffc107;
        }

        .detail-address {
            font-size: 16px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-address i {
            color: #777;
        }

        .detail-description {
            font-size: 15px;
            color: #444;
            line-height: 1.5;
        }

        .reviews-section h3 {
            margin: 20px 0 15px;
            font-size: 20px;
            color: #333;
        }

        .review-item {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .review-rating {
            color: #ffc107;
        }

        .review-text {
            font-size: 15px;
            color: #333;
            line-height: 1.4;
        }

        .add-review-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
        }

        .rating-stars .fas {
            color: #ffc107;
        }

        .no-reviews {
            text-align: center;
            padding: 15px;
            color: #777;
            font-style: italic;
        }
        
        /* Адаптивность */
        @media (max-width: 900px) {
            .sidebar {
                width: 300px;
            }
            
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .add-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .add-marker-form {
                width: 90%;
                max-width: 400px;
            }
            
            .places-container {
                max-height: 200px;
            }
            
            .place-detail-container {
                padding: 10px;
            }
            
            .detail-photo {
                height: 150px;
            }
            
            .reviews-section h3 {
                font-size: 18px;
            }
            
            .back-button {
                position: absolute;
                top: 10px;
                left: 10px;
                z-index: 1;
            }
            
            .detail-header {
                padding-top: 40px;
                position: relative;
            }
        }
    </style>
</head>
<body>
    <!-- Сайдбар с категориями-иконками -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Сириус</div>
        </div>
        
        <!-- Прокручиваемый контейнер для категорий -->
        <div class="categories-container">
            <div class="categories-grid">
                <div class="category-item active" data-category="All">
                    <div class="category-icon other">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="category-name">Все места</div>
                </div>
                
                <div class="category-item" data-category="Restaurant">
                    <div class="category-icon restaurant">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div class="category-name">Где поесть</div>
                </div>
                
                <div class="category-item" data-category="Monument">
                    <div class="category-icon monument">
                        <i class="fa-solid fa-monument"></i>
                    </div>
                    <div class="category-name">Памятники</div>
                </div>
                
                <div class="category-item" data-category="Hotel">
                    <div class="category-icon hotel">
                        <i class="fas fa-hotel"></i>
                    </div>
                    <div class="category-name">Гостиницы</div>
                </div>
                
                <div class="category-item" data-category="Theater">
                    <div class="category-icon theater">
                        <i class="fa-solid fa-masks-theater"></i>
                    </div>
                    <div class="category-name">Театры</div>
                </div>
                
                <div class="category-item" data-category="Shopping">
                    <div class="category-icon shopping">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="category-name">Торговые центры</div>
                </div>
                
                <div class="category-item" data-category="Cafe">
                    <div class="category-icon cafe">
                        <i class="fas fa-coffee"></i>
                    </div>
                    <div class="category-name">Кафе</div>
                </div>

                <div class="category-item" data-category="Cinema">
                    <div class="category-icon cinema">
                        <i class="fa-solid fa-film"></i>
                    </div>
                    <div class="category-name">Кинотеатры</div>
                </div>

                <div class="category-item" data-category="Gallery">
                    <div class="category-icon gallery">
                        <i class="fa-solid fa-image"></i>
                    </div>
                    <div class="category-name">Галереи</div>
                </div>

                <div class="category-item" data-category="Park">
                    <div class="category-icon park">
                        <i class="fa-solid fa-tree"></i>
                    </div>
                    <div class="category-name">Парк</div>
                </div>

                <div class="category-item" data-category="Other">
                    <div class="category-icon other">
                        <i class="fa-solid fa-ellipsis"></i>
                    </div>
                    <div class="category-name">Другое</div>
                </div>
            </div>
            </div>
            <div class="places-container" id="places-container"></div>
            <div class="place-detail-container" id="place-detail-container">
                <div class="detail-header">
                    <button id="back-button" class="back-button"><i class="fas fa-arrow-left"></i></button>
                    <h2 id="detail-title" class="detail-title">Название места</h2>
                </div>
                <img id="detail-photo" class="detail-photo" src="" alt="Фото места">
                <div class="detail-rating" id="detail-rating">
                    <span class="stars">★★★★★</span>
                    <span class="avg-rating">5.0</span>
                    <span class="reviews-count">(10 отзывов)</span>
                </div>
                <div class="detail-address" id="detail-address">Адрес</div>
                <div class="detail-description" id="detail-description">Описание места</div>
                
                <div class="reviews-section">
                    <h3>Отзывы</h3>
                    <div class="reviews-list" id="reviews-list">
                        <!-- Здесь будут отзывы -->
                    </div>
                    
                    <div class="add-review-form">
                        <h3>Оставить отзыв</h3>
                        <div class="form-group">
                            <label for="review-text">Ваш отзыв:</label>
                            <textarea id="review-text" rows="3" placeholder="Расскажите о вашем опыте"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Оценка:</label>
                            <div class="rating-stars">
                                <i class="far fa-star" data-rating="1"></i>
                                <i class="far fa-star" data-rating="2"></i>
                                <i class="far fa-star" data-rating="3"></i>
                                <i class="far fa-star" data-rating="4"></i>
                                <i class="far fa-star" data-rating="5"></i>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="submit-review">Отправить</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Секция для отображения мест по категориям -->
        
        
        <!-- Детали места (изначально скрыт) -->
        
    </div>
    
    <!-- Карта -->
    <div id="map"></div>
    
    <!-- Кнопка добавления -->
    <button class="add-button" id="add-button">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Форма добавления маркера -->
    <div class="add-marker-form" id="add-marker-form">
        <div class="form-header">
            <div class="form-title">Добавить новое место</div>
            <button class="close-btn" id="close-form-btn">&times;</button>
        </div>
        <div class="form-group">
            <label for="address-input">Адрес:</label>
            <input type="text" id="address-input" placeholder="Введите адрес">
        </div>
        <div class="form-group">
            <label for="marker-title">Название:</label>
            <input type="text" id="marker-title" placeholder="Название места">
        </div>
        <div class="form-group">
            <label for="marker-description">Описание:</label>
            <textarea id="marker-description" rows="3" placeholder="Дополнительная информация"></textarea>
        </div>
        <div class="form-group">
            <label for="marker-category">Категория:</label>
            <select id="marker-category">
                <option value="Other">Другие места</option>
                <option value="Museum">Музеи</option>
                <option value="Cafe">Кафе</option>
                <option value="Restaurant">Рестораны</option>
                <option value="Monument">Памятники</option>
                <option value="Shopping">Торговые центры</option>
                <option value="Theater">Театры</option>
                <option value="Cinema">Кинотеатры</option>
                <option value="Gallery">Галереи</option>
                <option value="Park">Парки</option>
                <option value="Hotel">Отели</option>
            </select>
        </div>
        <div class="form-group">
            <label>Фотография места:</label>
            <div class="file-upload">
                <div class="file-upload-btn">
                    <div>
                        <i class="fas fa-camera"></i>
                        <span id="file-btn-text">Выберите файл</span>
                    </div>
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <input type="file" id="marker-photo" class="file-upload-input" accept="image/png, image/jpeg">
                <div id="file-name" class="file-name"></div>
            </div>
            <div id="preview-container" class="preview-container">
                <img id="preview-image" class="preview-image" src="" alt="Предпросмотр фото">
            </div>
        </div>
        <!-- Добавил отступ перед кнопками -->
        <div style="height: 20px;"></div>
        <div class="form-buttons">
            <button class="btn btn-secondary" id="cancel-btn">Отмена</button>
            <button class="btn btn-primary" id="add-btn">Добавить</button>
        </div>
    </div>

    <!-- Подключаем необходимые библиотеки -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Инициализация карты
        const map = L.map('map').setView([43.402, 39.996], 13);
        
        // Используем слой без меток
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Массив для хранения маркеров
        let markers = [];
        
        // Элементы UI
        const addButton = document.getElementById('add-button');
        const addForm = document.getElementById('add-marker-form');
        const closeFormBtn = document.getElementById('close-form-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const addBtn = document.getElementById('add-btn');
        const fileInput = document.getElementById('marker-photo');
        const fileName = document.getElementById('file-name');
        const fileBtnText = document.getElementById('file-btn-text');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        
        // Элементы детального просмотра
        const placeDetailContainer = document.getElementById('place-detail-container');
        const backButton = document.getElementById('back-button');
        const detailTitle = document.getElementById('detail-title');
        const detailPhoto = document.getElementById('detail-photo');
        const detailRating = document.getElementById('detail-rating');
        const detailAddress = document.getElementById('detail-address');
        const detailDescription = document.getElementById('detail-description');
        const reviewsList = document.getElementById('reviews-list');
        const reviewText = document.getElementById('review-text');
        const submitReviewButton = document.getElementById('submit-review');
        
        // Цвета категорий
        const categoryColors = {
            'Museum': '#8dc157',
            'Cafe': '#ffa15e',
            'Restaurant': '#ffa15e',
            'Monument': '#8dc157',
            'Shopping': '#60a8f0',
            'Theater': '#8dc157',
            'Cinema': '#8dc157',
            'Gallery': '#8dc157',
            'Hotel': '#9c89fa',
            'Park': '#8dc157',
            'Other': '#60a8f0'
        };
        
        // Иконки категорий
        const categoryIcons = {
            'Museum': 'fa-landmark',
            'Cafe': 'fa-coffee',
            'Restaurant': 'fa-utensils',
            'Monument': 'fa-monument',
            'Shopping': 'fa-shopping-cart',
            'Theater': 'fa-theater-masks',
            'Cinema': 'fa-film',
            'Gallery': 'fa-image',
            'Hotel': 'fa-hotel',
            'Park': 'fa-tree',
            'Other': 'fa-ellipsis'
        };
        
        // Показать/скрыть форму
        addButton.addEventListener('click', () => {
            addForm.style.display = 'block';
            resetFileInput();
        });
        
        closeFormBtn.addEventListener('click', () => {
            addForm.style.display = 'none';
            resetFileInput();
        });
        
        cancelBtn.addEventListener('click', () => {
            addForm.style.display = 'none';
            resetFileInput();
        });
        
        // Обработка загрузки файла
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    resetFileInput();
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    console.log('Файл слишком большой. Максимальный размер 5MB');
                    resetFileInput();
                    return;
                }
                
                fileName.textContent = file.name;
                fileBtnText.textContent = 'Изменить файл';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        function formatDate(isoString) {
    const date = new Date(isoString);
    
    return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
        
        // Функция сброса загрузки файла
        function resetFileInput() {
            fileInput.value = '';
            fileName.textContent = '';
            fileBtnText.textContent = 'Выберите файл';
            previewContainer.style.display = 'none';
            previewImage.src = '';
        }
        
        // Добавление маркера
        addBtn.addEventListener('click', addMarker);

        // Функция геокодирования
        async function geocodeAddress(address) {
            try {
                const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                    params: {
                        format: 'json',
                        q: address,
                        limit: 1
                    }
                });
                
                if (response.data.length > 0) {
                    return {
                        lat: parseFloat(response.data[0].lat),
                        lon: parseFloat(response.data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Ошибка геокодирования:', error);
                return null;
            }
        }
        
        // Функция для загрузки мест по категории
        async function loadPlacesByCategory(category) {
            try {
                if(category == "All") {
                    const response = await axios.get(`http://localhost:8000/api/places/`);
                    displayPlaces(response.data.places); 
                }else {
                   const response = await axios.get(`http://localhost:8000/api/places/?category=${category}`);
                    displayPlaces(response.data.places); 
                }
            } catch (error) {
                console.error('Ошибка загрузки мест:', error);
            }
        }
        
        // Функция для отображения мест в интерфейсе
        function displayPlaces(places) {
            const container = document.getElementById('places-container');
            container.innerHTML = '';
            
            if (places.length === 0) {
                container.innerHTML = '<div class="no-places">Нет мест в этой категории</div>';
                return;
            }
            
            places.forEach(place => {
                const placeCard = document.createElement('div');
                placeCard.className = 'place-card';
                placeCard.dataset.id = place.id;
                
                let photoHtml = '';
                if (place.photo) {
                    photoHtml = `<img src="http://localhost:8000${place.photo}" class="place-photo" alt="${place.name}">`;
                }
                
                placeCard.innerHTML = `
                    <div class="place-header">
                        <div class="place-name">${place.name}</div>
                        <div class="place-rating">${Number(place.average_rating).toFixed(1) || 'Нет оценок'}</div>
                    </div>
                    ${photoHtml}
                    <div class="place-address">${place.address}</div>
                `;
                
                // Обработчик клика на карточке
                placeCard.addEventListener('click', () => {
                    loadPlaceDetails(place.id);
                    const markerObj = markers[place.id];
                    if (markerObj) {
                        map.setView([markerObj.lat, markerObj.lon], 15);
                        markerObj.marker.openPopup();
                    }
                });
                
                container.appendChild(placeCard);
            });
        }

        // Обработчики для категорий
        document.querySelectorAll('.category-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.category-item').forEach(el => {
                    el.classList.remove('active');
                });
                
                this.classList.add('active');
                const category = this.dataset.category;
                
                if (category === 'all') {
                    loadMarkers();
                } else if (category === 'featured') {
                    document.getElementById('places-container').innerHTML = '<div class="no-places">Раздел в разработке</div>';
                } else {
                    loadPlacesByCategory(category);
                }
            });
        });
        
        function updateMarkerPopup(placeId, newRating) {
            const markerObj = markers[String(placeId)];
    
    if (!markerObj) {
        console.error('Маркер не найден для места:', placeId);
        return;
    }
    
    // Обновляем рейтинг в объекте маркера
    markerObj.rating = newRating;
    
    // Полностью пересоздаем popup с новыми данными
    const color = categoryColors[markerObj.category] || '#60a8f0';
    const iconClass = categoryIcons[markerObj.category] || 'fa-map-marker-alt';
    
    let popupContent = `
        <div style="min-width: 250px;">
            <h3 style="margin: 0 0 10px; color: ${color}; font-size: 18px;">
                <i class="fas ${iconClass}" style="margin-right: 8px;"></i>${markerObj.title}
            </h3>
            <p style="margin-bottom: 5px;"><strong>Адрес:</strong> ${markerObj.address}</p>
            <p style="margin-bottom: 10px; color: #555;">${markerObj.description}</p>
    `;
    
    if (markerObj.photo) {
        popupContent += `
            <div style="margin-bottom: 10px;">
                <img src="${markerObj.photo}" style="width:100%; max-height:150px; object-fit:cover; border-radius:8px;">
            </div>
        `;
    }
    
    popupContent += `
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 15px; color: #555;">
            <span style="font-weight: 500;">Рейтинг:</span>
            <span style="color: #ffc107; font-weight: bold;">
                ${newRating.toFixed(1)}
            </span>
        </div>
    </div>
    `;
    
    // Полностью пересоздаем popup
    markerObj.marker.unbindPopup();
    markerObj.marker.bindPopup(popupContent);
    
    markerObj.marker.closePopup();
        markerObj.marker.openPopup();
    // Если popup был открыт - переоткрываем его с новыми данными
    // if (markerObj.marker.isPopupOpen()) {
    //     markerObj.marker.closePopup();
    //     markerObj.marker.openPopup();
    // }
}

        // Загрузка маркеров с сервера
        async function loadMarkers() {
            try {
                const response = await axios.get('http://localhost:8000/api/places/');
                const places = response.data.places;

                // Очищаем существующие маркеры
                for (const id in markers) {
    map.removeLayer(markers[id].marker);
}
markers = {};
                // Очищаем список мест
                document.getElementById('places-container').innerHTML = '';

                // Добавляем маркеры с сервера
                for (const place of places) {
                    if (place.lat && place.lng) {
                        let photoUrl = null;
                        if (place.photo) {
                            photoUrl = `http://localhost:8000${place.photo}`;
                        }

                        let category = place.category;
                        if (Array.isArray(category)) {
                            category = category.length > 0 ? category[0] : 'Other';
                        }


                        
            markers[String(place.id)] = createMarker(
                            place.lat,
                            place.lng,
                            place.address,
                            place.name,
                            place.description,
                            category,
                            photoUrl,
                            false,
                            place.id,
                            place.average_rating
                        );

                            
                    }
                }

                const markerIds = Object.keys(markers);
if (markerIds.length > 0) {
    const lastId = markerIds[markerIds.length - 1];
    const lastMarker = markers[lastId];
    map.setView([lastMarker.lat, lastMarker.lon], 13);
}

            } catch (error) {
                console.error('Ошибка загрузки маркеров:', error);
            }
        }

        // Модифицированная функция добавления маркера
        async function addMarker() {
            const address = document.getElementById('address-input').value;
            const title = document.getElementById('marker-title').value || address;
            const description = document.getElementById('marker-description').value || 'Без описания';
            const category = document.getElementById('marker-category').value;
            const photoFile = fileInput.files[0];
            
            if (!address) {
                return;
            }

            try {
                const result = await geocodeAddress(address);
                if (!result) {
                    return;
                }

                const formData = new FormData();
                formData.append('name', title);
                formData.append('address', address);
                formData.append('description', description);
                formData.append('category', category);
                formData.append('lat', result.lat);
                formData.append('lng', result.lon);
                
                if (photoFile) {
                    formData.append('photo', photoFile);
                }

                const response = await axios.post(
                    'http://localhost:8000/api/places/add/', 
                    formData,
                    {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                        }
                    }
                );

                if (response.data.success) {
                    let photoUrl = null;
                    if (response.data.photo_url) {
                        photoUrl = `http://localhost:8000${response.data.photo_url}`;
                    }
                    markers[String(response.data.place_id)] = createMarker(
                        result.lat,
                        result.lon,
                        address,
                        title,
                        description,
                        category,
                        photoUrl,
                        true,
                        response.data.place_id
                    );

                    addForm.style.display = 'none';
                    resetFileInput();
                } else {
                    let errorMessage = 'Ошибка при добавлении места:\n';
                    for (const field in response.data.errors) {
                        errorMessage += `${field}: ${response.data.errors[field].join(', ')}\n`;
                    }
                }
            } catch (error) {
                console.error('Ошибка добавления места:', error);
                
                if (error.response?.data?.errors) {
                    let errorMessage = 'Ошибка при добавлении места:\n';
                    for (const field in error.response.data.errors) {
                        errorMessage += `${field}: ${error.response.data.errors[field].join(', ')}\n`;
                    }
                } else {
                }
            }
        }

        // Создание маркера с поддержкой фото
        function createMarker(lat, lon, address, title, description, category = 'OTHER', photoUrl = null, center = true, id, avg_rating) {
            if (Array.isArray(category)) {
                category = category.length > 0 ? category[0] : 'Other';
            }
            
            const color = categoryColors[category] || '#60a8f0';
            const iconClass = categoryIcons[category] || 'fa-map-marker-alt';
            
            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${color}; 
                        width: 32px; height: 32px; border-radius: 50%; display: flex; 
                        justify-content: center; align-items: center; color: white; 
                        font-weight: bold; border: 2px solid white; 
                        box-shadow: 0 3px 8px rgba(0,0,0,0.3);">
                        <i class="fas ${iconClass}"></i>
                      </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            const marker = L.marker([lat, lon], { icon: customIcon }).addTo(map);
            
            let popupContent = `
                <div style="min-width: 250px;">
                    <h3 style="margin: 0 0 10px; color: ${color}; font-size: 18px;">
                        <i class="fas ${iconClass}" style="margin-right: 8px;"></i>${title}
                    </h3>
                    <p style="margin-bottom: 5px;"><strong>Адрес:</strong> ${address}</p>
                    <p style="margin-bottom: 10px; color: #555;">${description}</p>
            `;
            
            if (photoUrl) {
                popupContent += `
                    <div style="margin-bottom: 10px;">
                        <img src="${photoUrl}" style="width:100%; max-height:150px; object-fit:cover; border-radius:8px;">
                    </div>
                `;
            }
            
            popupContent += `
    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 15px; color: #555;">
        <span style="font-weight: 500;">Рейтинг:</span>
        <span style="color: #ffc107; font-weight: bold;">
            ${avg_rating ? Number(avg_rating).toFixed(1) : 'Нет оценок'}
        </span>
    </div>
</div>
`;
            
            marker.bindPopup(popupContent);
            
            if (center) {
                marker.openPopup();
                map.setView([lat, lon], 15);
            }
            
            const markerObj = {
                marker: marker,
                address: address,
                title: title,
                description: description,
                category: category,
                photo: photoUrl,
                lat: lat,
                lon: lon,
                rating: avg_rating,
                id: id
            };
            
            
            
            
            // Добавляем обработчик клика на маркер
            marker.on('click', function() {
                if (id) {
                    loadPlaceDetails(id);
                }
            });
            return markerObj;
        }
        
       

        // Обработчик кнопки "Назад"
        backButton.addEventListener('click', function() {
            placeDetailContainer.style.display = 'none';
            document.querySelector('.categories-container').style.display = 'block';
            document.getElementById('places-container').style.display = 'block';
        });
        

        // Функция загрузки деталей места
        async function loadPlaceDetails(placeId) {
            try {
                const response = await axios.get(`http://localhost:8000/api/places/${placeId}/`);
                const place = response.data;

                // Заполняем детали
                detailTitle.textContent = place.name;
                detailAddress.textContent = place.address;
                detailDescription.textContent = place.description || 'Описание отсутствует';

                // Фото
                if (place.photo) {
                    detailPhoto.src = `http://localhost:8000${place.photo}`;
                    detailPhoto.style.display = 'block';
                } else {
                    detailPhoto.style.display = 'none';
                }

                // Рейтинг
                const avgRating = place.average_rating || 0;
                const reviewsCount = place.reviews.length || 0;
                detailRating.innerHTML = `
                    <span class="stars">${renderStars(avgRating)}</span>
                    <span class="avg-rating">${avgRating.toFixed(1)}</span>
                    <span class="reviews-count">(${reviewsCount} отзывов)</span>
                `;

                // Отзывы
                reviewsList.innerHTML = '';
                if (place.reviews && place.reviews.length > 0) {
                    place.reviews.forEach(review => {
                        const reviewEl = document.createElement('div');
                        reviewEl.className = 'review-item';
                        reviewEl.innerHTML = `
                            <div class="review-header">
                                <span class="review-rating">${renderStars(review.rating)}</span>
                                <span class="review-date">${formatDate(review.date)}</span>
                            </div>
                            <div class="review-text">${review.comment}</div>
                        `;
                        reviewsList.appendChild(reviewEl);
                    });
                } else {
                    reviewsList.innerHTML = '<div class="no-reviews">Нет отзывов</div>';
                }

                // Показываем контейнер с деталями
                document.querySelector('.categories-container').style.display = 'none';
                document.getElementById('places-container').style.display = 'none';
                placeDetailContainer.style.display = 'block';

                // Сохраняем ID места
                submitReviewButton.dataset.placeId = placeId;

            } catch (error) {
                console.error('Ошибка загрузки деталей места:', error);
                
                // Показываем сообщение об ошибке
                reviewsList.innerHTML = '<div class="no-reviews">Ошибка загрузки данных места</div>';
                
                // Заполняем хотя бы основную информацию
                detailTitle.textContent = 'Ошибка загрузки';
                detailAddress.textContent = '';
                detailDescription.textContent = 'Не удалось загрузить информацию о месте.';
                
                // Показываем контейнер с деталями
                document.querySelector('.categories-container').style.display = 'none';
                document.getElementById('places-container').style.display = 'none';
                placeDetailContainer.style.display = 'block';
            }
        }

        // Вспомогательная функция для отрисовки звезд
        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating - fullStars >= 0.5;
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    starsHtml += '<i class="fas fa-star"></i>';
                } else if (halfStar && i === fullStars + 1) {
                    starsHtml += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHtml += '<i class="far fa-star"></i>';
                }
            }
            return starsHtml;
        }

        // Обработчик для звезд рейтинга
        document.querySelectorAll('.rating-stars i').forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                setRating(rating);
            });
        });

        function setRating(rating) {
            const stars = document.querySelectorAll('.rating-stars i');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far', 'fa-star-half-alt');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas', 'fa-star-half-alt');
                    star.classList.add('far');
                }
            });
            document.querySelector('.rating-stars').dataset.rating = rating;
        }

        // Обработчик отправки отзыва
        submitReviewButton.addEventListener('click', async function() {
    const placeId = this.dataset.placeId;
    const text = reviewText.value;
    const rating = document.querySelector('.rating-stars').dataset.rating;
    if (rating == 0) {
        return;
    }

    try {
        const formData = new FormData();
        formData.append('place', placeId);
        formData.append('rating', rating);
        formData.append('comment', text);

        const response = await axios.post(
            'http://localhost:8000/api/reviews/add/',
            formData
        );

        if (response.data.success) {
            // Получаем обновленный рейтинг места
            const updatedResponse = await axios.get(`http://localhost:8000/api/places/${placeId}/`);
            const updatedPlace = updatedResponse.data;
            const newRating = updatedPlace.average_rating;
            
        
        // Обновляем popup маркера (передаем новый рейтинг)
        updateMarkerPopup(String(placeId), newRating);
            
            // Перезагружаем детали места
            loadPlaceDetails(placeId);
            
            // Сбрасываем форму отзыва
            reviewText.value = '';
            setRating(0);
            
        } else {
            console.error('Ошибка: ' + JSON.stringify(response.data.errors));
        }
    } catch (error) {
        console.error('Ошибка отправки отзыва:', error);
    }
});

        // Инициализация при загрузке страницы
        window.onload = function() {
            loadMarkers();
            // Инициализация рейтинга
            setRating(0);
        };

    </script>
</body>
</html>